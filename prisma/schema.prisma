generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== MULTI-TENANT MODELS ==========

enum SubscriptionPlan {
  BASIC
  PROFESSIONAL
  ENTERPRISE

  @@map("subscription_plan")
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELED
  EXPIRED

  @@map("subscription_status")
}

model Business {
  id                String              @id @default(cuid())
  name              String
  email             String              @unique
  phone             String?
  address           String?
  password          String
  subscriptionPlan  SubscriptionPlan    @default(BASIC)
  subscriptionStatus SubscriptionStatus @default(ACTIVE) @map("subscription_status")
  subscriptionStartDate DateTime?       @map("subscription_start_date")
  subscriptionEndDate DateTime?         @map("subscription_end_date")
  monthlyPrice      Decimal             @default(99.99) @db.Decimal(10, 2) @map("monthly_price")
  isActive          Boolean             @default(true) @map("is_active")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  
  // Relacionamentos
  customers         Customer[]
  cars              Car[]
  services          Service[]
  categories        Category[]
  appointments      Appointment[]
  ratings           CustomerRating[]
  settings          BusinessSettings?
  packages          ServicePackage[]
  notificationTemplates NotificationTemplate[]
  notificationLogs  NotificationLog[]
  appointmentCancellations AppointmentCancellation[]

  @@map("businesses")
}

model BusinessSettings {
  id                       String   @id @default(cuid())
  businessId               String   @unique @map("business_id")
  business                 Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Horário funcionamento
  openingTimeWeekday       String   @map("opening_time_weekday")
  closingTimeWeekday       String   @map("closing_time_weekday")
  slotIntervalMinutes      Int      @map("slot_interval_minutes")
  maxCarsPerSlot           Int      @map("max_cars_per_slot")
  timezone                 String   @default("America/Sao_Paulo")
  
  // Reputação
  reputationEnabled        Boolean  @default(true) @map("reputation_enabled")
  reputationAdvancePercent Int      @default(50) @map("reputation_advance_percent")
  reputationMinForAdvance  Decimal  @default(3.0) @map("reputation_min_for_advance") @db.Decimal(2, 1)
  reputationNoShowPenalty  Decimal  @default(2.5) @map("reputation_no_show_penalty") @db.Decimal(2, 1)
  reputationRecoveryOnShow Boolean  @default(true) @map("reputation_recovery_on_show")
  
  // Notificações
  notificationsEnabled     Boolean  @default(true) @map("notifications_enabled")
  notificationChannel      String   @default("email") @map("notification_channel") // email, sms, whatsapp
  notifyOn24hBefore       Boolean  @default(true) @map("notify_on_24h_before")
  notifyOn1hBefore        Boolean  @default(true) @map("notify_on_1h_before")
  
  // Pacotes
  packagesEnabled          Boolean  @default(true) @map("packages_enabled")
  
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  @@map("business_settings")
}

model Service {
  id                  String               @id @default(cuid())
  businessId          String               @map("business_id")
  business            Business             @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  name                String
  description         String?
  durationMinutes     Int                  @map("duration_minutes")
  price               Decimal              @db.Decimal(10, 2)
  isActive            Boolean              @default(true) @map("is_active")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  serviceGroup        String?              @map("service_group")
  categoryId          String?              @map("category_id")
  
  category            Category?            @relation(fields: [categoryId], references: [id])
  appointmentServices AppointmentService[]
  packageServices     PackageService[]

  @@unique([businessId, name])
  @@map("services")
}

model Category {
  id          String    @id @default(cuid())
  businessId  String    @map("business_id")
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  services    Service[]

  @@unique([businessId, name])
  @@map("categories")
}

model Customer {
  id                  String        @id @default(cuid())
  businessId          String        @map("business_id")
  business            Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  name                String
  phone               String
  email               String?
  password            String?
  notes               String?
  isAdmin             Boolean       @default(false) @map("is_admin")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  completedCount      Int           @default(0) @map("completed_count")
  noShowCount         Int           @default(0) @map("no_show_count")
  rating              Decimal       @default(5.0) @db.Decimal(2, 1)
  googleId            String?       @unique @map("google_id")
  phoneVerified       Boolean       @default(false) @map("phone_verified")
  verificationCode    String?       @map("verification_code")
  verificationExpiry  DateTime?     @map("verification_expiry")
  
  appointments        Appointment[]
  cars                Car[]
  ratings             CustomerRating[]
  notificationLogs    NotificationLog[]

  @@unique([businessId, phone])
  @@unique([businessId, email])
  @@map("customers")
}

model Car {
  id           String        @id @default(cuid())
  businessId   String        @map("business_id")
  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customerId   String        @map("customer_id")
  
  plate        String
  model        String
  color        String?
  year         Int?
  vehicleType  VehicleType   @default(HATCH) @map("vehicle_type")
  notes        String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  
  appointments Appointment[]
  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([businessId, plate])
  @@map("cars")
}

enum VehicleType {
  HATCH
  SEDAN
  SUV
  PICKUP
  MOTO
  VAN

  @@map("vehicle_type")
}

model Appointment {
  id                    String               @id @default(cuid())
  businessId            String               @map("business_id")
  business              Business             @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customerId            String               @map("customer_id")
  carId                 String               @map("car_id")
  
  startDatetime         DateTime             @map("start_datetime")
  endDatetime           DateTime             @map("end_datetime")
  status                AppointmentStatus    @default(PENDING)
  totalPrice            Decimal              @map("total_price") @db.Decimal(10, 2)
  notes                 String?
  businessNotes         String?              @map("business_notes")
  suggestedDatetime     DateTime?            @map("suggested_datetime")
  confirmedByClientAt   DateTime?            @map("confirmed_by_client_at")
  confirmedByBusinessAt DateTime?            @map("confirmed_by_business_at")
  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @updatedAt @map("updated_at")
  
  appointmentServices   AppointmentService[]
  cancellation          AppointmentCancellation?
  car                   Car                  @relation(fields: [carId], references: [id])
  customer              Customer             @relation(fields: [customerId], references: [id])

  @@index([businessId, startDatetime])
  @@index([businessId, status])
  @@map("appointments")
}

model AppointmentService {
  id            String      @id @default(cuid())
  appointmentId String      @map("appointment_id")
  serviceId     String      @map("service_id")
  price         Decimal     @db.Decimal(10, 2)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service       Service     @relation(fields: [serviceId], references: [id])

  @@map("appointment_services")
}

model Settings {
  id                       String   @id @default(cuid())
  openingTimeWeekday       String   @map("opening_time_weekday")
  closingTimeWeekday       String   @map("closing_time_weekday")
  slotIntervalMinutes      Int      @map("slot_interval_minutes")
  maxCarsPerSlot           Int      @map("max_cars_per_slot")
  timezone                 String   @default("America/Sao_Paulo")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")
  reputationAdvancePercent Int      @default(50) @map("reputation_advance_percent")
  reputationEnabled        Boolean  @default(true) @map("reputation_enabled")
  reputationMinForAdvance  Decimal  @default(3.0) @map("reputation_min_for_advance") @db.Decimal(2, 1)
  reputationNoShowPenalty  Decimal  @default(2.5) @map("reputation_no_show_penalty") @db.Decimal(2, 1)
  reputationRecoveryOnShow Boolean  @default(true) @map("reputation_recovery_on_show")

  @@map("settings")
}

enum AppointmentStatus {
  PENDING
  CONFIRMED_BY_CLIENT
  CONFIRMED
  RESCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELED
  NO_SHOW

  @@map("appointment_status")
}

// ========== NOVOS MODELOS PARA FUNCIONALIDADES ==========

model ServicePackage {
  id          String   @id @default(cuid())
  businessId  String   @map("business_id")
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  discountPercent Decimal @db.Decimal(5, 2) @map("discount_percent")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  services    PackageService[]

  @@unique([businessId, name])
  @@map("service_packages")
}

model PackageService {
  id        String   @id @default(cuid())
  packageId String   @map("package_id")
  serviceId String   @map("service_id")
  
  package   ServicePackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  service   Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([packageId, serviceId])
  @@map("package_services")
}

model AppointmentCancellation {
  id            String   @id @default(cuid())
  businessId    String   @map("business_id")
  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  appointmentId String   @unique @map("appointment_id")
  
  reason        String   // motivo do cancelamento
  canceledBy    String   @map("canceled_by") // 'customer' ou 'business'
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")
  
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@map("appointment_cancellations")
}

model CustomerRating {
  id           String   @id @default(cuid())
  businessId   String   @map("business_id")
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customerId   String   @map("customer_id")
  
  rating       Decimal  @db.Decimal(2, 1)
  comment      String?
  createdAt    DateTime @default(now()) @map("created_at")
  
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_ratings")
}

enum NotificationTemplateType {
  APPOINTMENT_CREATED
  APPOINTMENT_CONFIRMED
  APPOINTMENT_CANCELED
  APPOINTMENT_RESCHEDULED
  APPOINTMENT_24H_REMINDER
  APPOINTMENT_1H_REMINDER
  APPOINTMENT_COMPLETED

  @@map("notification_template_type")
}

model NotificationTemplate {
  id        String                   @id @default(cuid())
  businessId String                  @map("business_id")
  business  Business                 @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  type      NotificationTemplateType
  title     String
  body      String
  isActive  Boolean                  @default(true) @map("is_active")
  createdAt DateTime                 @default(now()) @map("created_at")
  updatedAt DateTime                 @updatedAt @map("updated_at")

  @@unique([businessId, type])
  @@map("notification_templates")
}

model NotificationLog {
  id           String   @id @default(cuid())
  businessId   String   @map("business_id")
  customerId   String?  @map("customer_id")
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer     Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  type         String
  channel      String   // email, sms, whatsapp
  recipient    String   // email ou telefone
  subject      String?
  body         String
  sentAt       DateTime @default(now()) @map("sent_at")
  status       String   @default("pending") // pending, sent, failed
  errorMessage String?  @map("error_message")

  @@index([businessId, sentAt])
  @@map("notification_logs")
}
